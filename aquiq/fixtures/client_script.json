[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2023-09-28 11:07:07.811112",
  "module": "Aquiq",
  "name": "Item Component",
  "script": "frappe.ui.form.on('Sales Order', {\nrefresh(frm) {\n    var dialogOpen = false;\n\n    $(frm.wrapper).on('mouseenter', '.frappe-control[data-fieldname=\"unique_id\"]', function () {\n        var uniqueIdValue = $(this).find('input').val();\n        var totalRate = 0;\n\n        frappe.call({\n            method: 'aquiq.services.rest.get_item_code',\n            args: {\n                'unique_id': uniqueIdValue\n            },\n            callback: function (r) {\n                var itemCode = r.message[0].item_code;\n                $(document).on('keydown', function (e) {\n                    if (e.ctrlKey && e.key === 'p' && !dialogOpen) {\n                        e.preventDefault();\n                        dialogOpen = true;\n                        var selectedComponent = null;\n                        var dialog = new frappe.ui.Dialog({\n                            title: __('Add Item Components'),\n                            fields: [\n                                {\n                                    fieldname: 'custom_item_components',\n                                    label: __('Item Components'),\n                                    fieldtype: 'Table',\n                                    fields: [\n                                        {\n                                            fieldtype: 'Data',\n                                            fieldname: 'unique_id',\n                                            label: __('Unique ID'),\n                                            in_list_view: 1,\n                                            default: uniqueIdValue,\n                                            reqd: 1,\n                                            read_only: 1 \n                                        },\n                                        {\n                                            fieldtype: 'Link',\n                                            fieldname: 'component_name',\n                                            label: __('Item'),\n                                            options: 'Item',\n                                            in_list_view: 1,\n                                             onchange: function () {\n                                                var selectedComponent = document.querySelector('[data-fieldname=\"component_name\"] input').value;\n                                                frm.doc.price = selectedComponent;\n                                                frm.refresh_field('price');\n                                                \n                                            },\n                                        },\n                                        {\n                                            fieldtype: 'Float',\n                                            fieldname: 'qty',\n                                            label: __('Qty'),\n                                            in_list_view: 1\n                                        },\n                                        {\n                                            fieldtype: 'Currency',\n                                            fieldname: 'price',\n                                            label: __('Price'),\n                                            in_list_view: 1,\n                                            default: 0,\n                                            read_only: 1 \n                                        },\n                                        {\n                                            fieldtype: 'Currency',\n                                            fieldname: 'amount',\n                                            label: __('Amount'),\n                                            in_list_view: 1,\n                                            read_only: 1 \n                                        }\n                                    ],\n                                    \n                                    data: (frm.doc.custom_item_components || []).filter(da => da.unique_id === uniqueIdValue).map(da => ({\n                                        unique_id: da.unique_id,\n                                        component_name: da.component_name,\n                                        qty: da.qty,\n                                        price: da.price,\n                                        amount: da.amount\n                                    })),\n                                    fields_map: {\n                                        unique_id: 'Unique ID',\n                                        component_name: 'Item',\n                                        qty: 'Qty',\n                                        price: 'Price',\n                                        amount: 'Amount'\n                                    },\n                                    get_data: function () {\n                                        \n                                        return (frm.get_value('custom_item_components') || []).filter(da => da.unique_id === uniqueIdValue).map(da => ({\n                                            unique_id: da.unique_id,\n                                            component_name: da.component_name,\n                                            qty: da.qty,\n                                            price: da.price,\n                                            amount: da.amount\n                                        }));\n                                    }\n                                }\n                            ]\n                        });\n                        dialog.set_primary_action('Save', function () {\n                                var data = dialog.get_values();\n                                var customItemComponents = data.custom_item_components;\n                                var lastItem = customItemComponents[customItemComponents.length - 1];\n                                if (data) {\n                                    var Addamonts = 0;\n                                        var item = lastItem;\n                                        frappe.call({\n                                            method: 'aquiq.services.rest.get_price',\n                                            args: {\n                                                'item_code': item.component_name\n                                            },\n                                            callback: function(r) {\n                                                let price_data = r.message[0];\n                                                let price = price_data.price_list_rate;\n                                                \n                                                var childTable = frm.add_child('custom_item_components');\n                                                childTable.unique_id = uniqueIdValue;\n                                                childTable.component_name = item.component_name;\n                                                childTable.qty = item.qty;\n                                                childTable.price = price;\n                                                Addamonts=item.qty*price;\n                                                childTable.amount = Addamonts;\n                                                refresh_field('custom_item_components');\n                                                var item_row = frm.doc.items.find(row => row.unique_id === uniqueIdValue);\n                                                var sumAmounts = frm.doc.custom_item_components\n                                                    .filter(row => row.unique_id === uniqueIdValue)\n                                                    .map(row => parseFloat(row.amount))\n                                                    .reduce((acc, val) => acc + val, 0);\n                                                totalRate=sumAmounts+Addamonts;\n                                                if (item_row) {\n                                                    \n                                                    item_row.rate = totalRate;\n                                                    refresh_field('items');\n                                                }\n                                                frm.save\n                                                dialog.hide();\n                                                \n                                            }\n                                        });\n                                        \n                                    \n                                    \n\n                                    \n                                }\n                            });\n\n\n\n                        dialog.show();\n                    }\n                });\n\n            }\n\n        });\n    });\n}\n,\n})\n\nfrappe.ui.form.on('Sales Order Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\nitems_add(frm,cdt,cdn){\n    console.log(\"hae there\");\n    \n},\nitems_remove(frm, cdt, cdn) {\n    const childitems=frm.doc.items;\n    frm.clear_table('custom_item_components');\n    for (var i = 0; i < childitems.length; i++) {\n        var totalRate = 0;\n        const unique_id=childitems[i].unique_id;\n        const item_code=childitems[i].item_code;\n        frappe.call({\n            method: 'aquiq.aquiq.doctype.item_component.item_component.get_child_data_after',\n            args: {\n                'item_codes': item_code\n            },\n            callback: function (r) {\n                if (r.message) {\n                    var existing_items = frm.doc.custom_item_components || [];\n    \n                    $.each(r.message, function (_i, e) {\n                        var existing_row = existing_items.find(row => row.item_code === e.data.item_code);\n                        \n                        var row = frappe.model.add_child(frm.doc, 'Custom Item Component', 'custom_item_components');\n                        row.unique_id = unique_id;\n                        row.item = e.data.item;\n                        row.component_name = e.data.component_name;\n                        row.qty = e.data.qty;\n                        \n                        row.price = e.price_data[0].price_list_rate;\n                        var product = row.qty * row.price;\n                        row.amount = product;\n                        totalRate += product;\n                    });\n    \n                    refresh_field('custom_item_components');\n                    frm.refresh_field('total_amount');\n                    var item_row = frm.doc.items.find(row => row.unique_id === unique_id);\n                    if (item_row) {\n                        item_row.rate = totalRate;\n                        refresh_field('items');\n                    }\n                    \n                }\n            }\n        });\n    }\n    \n},\n\t\n    item_code: function (frm, cdt, cdn) {\n        var child_doc = locals[cdt][cdn];\n        var item_code = child_doc.item_code;\n        var totalRate = 0;\n        frappe.call({\n            method: 'aquiq.aquiq.doctype.item_component.item_component.get_child_data',\n            args: {\n                'item_codes': item_code\n            },\n            callback: function (r) {\n                if (r.message) {\n                    var existing_items = frm.doc.custom_item_components || [];\n    \n                    $.each(r.message, function (_i, e) {\n                        var existing_row = existing_items.find(row => row.item_code === e.data.item_code);\n                        \n                        var row = frappe.model.add_child(frm.doc, 'Custom Item Component', 'custom_item_components');\n                        row.unique_id = e.data.unique_id;\n                        row.item = e.data.item;\n                        row.component_name = e.data.component_name;\n                        row.qty = e.data.qty;\n                        \n                        row.price = e.price_data[0].price_list_rate;\n                        var product = row.qty * row.price;\n                        row.amount = product;\n                        totalRate += product;\n                    });\n                    \n    \n                    refresh_field('custom_item_components');\n                    frm.refresh_field('rate'); \n                    var item_row = frm.doc.items.find(row => row.unique_id === uniqueIdValue);\n                    var sumAmounts = frm.doc.custom_item_components\n                        .filter(row => row.unique_id === uniqueIdValue)\n                        .map(row => parseFloat(row.amount))\n                        .reduce((acc, val) => acc + val, 0);\n                    if (item_row) {\n                        item_row.rate = sumAmounts;\n                        refresh_field('items');\n                    }\n                    \n                }\n            }\n        });\n    },\n    \n\n\tonload_post_render: function (frm) {\n\t\tfrm.fields_dict['items'].$input.on('change', function () {\n\t\t\tif (!frm.doc.item_code) {\n\t\t\t\tfrm.clear_table('custom_item_components');\n\t\t\t}\n\t\t});\n\t},\n});\n\n\nfrappe.ui.form.on('Item Component', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2023-09-19 12:56:09.995436",
  "module": "Aquiq",
  "name": "Generate Unique",
  "script": "frappe.ui.form.on('Sales Order', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})\n\nfrappe.ui.form.on('Sales Order Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\nitem_code: function (frm, cdt, cdn) {\n        var child_doc = locals[cdt][cdn];\n        var item_code = child_doc.item_code;\n        var exists = frm.doc.custom_item_components.some(function (component) {\n            return component.item_code === item_code;\n        });\n\n        if (!exists) {\n            var uniqueID = generateUniqueID();\n            frappe.model.set_value(cdt, cdn, 'unique_id', uniqueID);\n        }\n        frm.refresh_field('items');\n        $.each(frm.doc.custom_item_components, function (i, row) {\n            if (!row.unique_id) {\n                frappe.model.set_value(row.doctype, row.name, 'unique_id', uniqueID);\n            }\n        });\n        frm.refresh_field('custom_item_components');\n    }\n})\n\n\nfunction generateUniqueID() {\n  const symbols = \"!@#$%^&*()_+{}[]:;,.?/\";\n  const letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n  const numbers = \"0123456789\";\n\n  const randomCharPool = symbols + letters + numbers;\n  const charPoolLength = randomCharPool.length;\n\n  const timestamp = Date.now().toString(36);\n\n  let uniqueID = timestamp;\n\n  for (let i = 0; i < 5; i++) {\n    const randomIndex = Math.floor(Math.random() * charPoolLength);\n    uniqueID += randomCharPool.charAt(randomIndex);\n  }\n\n  return uniqueID;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2023-09-28 11:07:38.296615",
  "module": "Aquiq",
  "name": "Delivery Note",
  "script": "frappe.ui.form.on('Delivery Note', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tvalidate:function(frm,cdt,cdn){\n\t    var item = locals[cdt][cdn];\n\t    var doc = frm.doc;\n\t    \n         for (var i = 0; i < item.items.length; i++) {\n\t        let pieces=item.items[i].pieces;\n\t        frappe.call({\n                method: 'aquiq.services.rest.set_quantity',\n                args: {\n                    'pieces':pieces\n                    \n                },\n                callback: function(r) {\n                     refresh_field('items');\n                }\n            });\n\n\t       \n\t    }\n\n\t}\n})\n\nfrappe.ui.form.on('Delivery Note Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2023-09-28 11:04:46.370868",
  "module": "Aquiq",
  "name": "Purchase Receipt",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n    refresh: function(frm) {\n        let childitems = frm.doc.items;\n        for (var i = 0; i < childitems.length; i++) {\n            let order_name = childitems[i].purchase_order_item;\n            if (!childitems[i].pieces) {\n                frappe.call({\n                    method: 'aquiq.services.rest.get_piece',\n                    args: {\n                        'order_name': order_name,\n                        'purchase_order': frm.doc.name\n                    },\n                    callback: function(r) {\n                        var item_row = frm.doc.items.find(row => row.purchase_order_item === r.message[0]);\n                        if (item_row) {\n                            item_row.pieces = r.message[1];\n                        }\n                    }\n                });\n            }\n        }\n    },\n\ton_submit:function(frm){\n\t    let childitems=frm.doc.items;\n\t    for (var i = 0; i < childitems.length; i++) {\n\t        let order_name=childitems[i].purchase_order_item;\n\t        let pieces=childitems[i].pieces;\n\t        frappe.call({\n                method: 'aquiq.services.rest.get_piecess',\n                args: {\n                    'order_name':order_name,\n                    'pieces':pieces\n                },\n                callback: function(r) {\n                }\n            });\n\n\t    }\n\n\t}\n\n})\n\nfrappe.ui.form.on('Purchase Receipt Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 }
]